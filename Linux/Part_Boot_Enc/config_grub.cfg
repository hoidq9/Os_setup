insmod part_msdos
insmod part_gpt
insmod ext2
insmod tpm
insmod cryptodisk
insmod luks
insmod luks2
insmod tpm2_key_protector
insmod search
insmod search_fs_file
insmod crypto
insmod search_fs_uuid
insmod at_keyboard
insmod usb_keyboard
insmod fat
insmod xfs
insmod configfile
insmod test
insmod hashsum

search --no-floppy --fs-uuid --set=first (efi_uuid)

tpm2_key_protector_init -T ($first)/sealed.tpm

cryptomount -u (boot_locked_uuid) -P tpm2

search --no-floppy --fs-uuid --set=root (boot_unlocked_uuid)

set prefix=($root)

if hashsum --hash sha256 --prefix $prefix --check $prefix/expected.sha256; then
    echo "Hash OK â€” booting system"
    configfile ($root)/grub2/grub.cfg
fi

